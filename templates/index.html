<!-- /templates/index.html (updated) -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defender Central</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <!-- Testing VirusTotalAPI and Zenrows -->
    <!-- Tested Malicious URL: hxxps://papiculo[.]net/unmiconfig.json -->
    <!-- Compatible URL: https://www.fortinet.com/blog/threat-research/malicious-pypi-packages-deploy-coinminer-on-linux-devices -->

    <h1>Testing VirusTotal and Zenrows APIs</h1>
    <form id="scanForm">
        <label for="urlInput">Enter URL to scan:</label>
        <input type="text" id="urlInput" name="url" required>
        <button type="button" onclick="scanURL()">Scan</button>
    </form>

    <div id="resultContainer" style="display: none;">
        <h2>Scan Results</h2>
        <pre id="scanResults"></pre>
        <h2>Analysis Report</h2>
        <pre id="analysisReport"></pre>
        <h2>Community Comments</h2>
        <pre id="communityComments"></pre>
        <h2>Zenrows Analysis</h2>
        <pre id="zenrowsAnalysis"></pre>
    </div>
    
    <script>
        function scanURL() {
            var url = $('#urlInput').val();

            $.ajax({
                type: 'POST',
                url: '/scan_url',
                data: { url: url },
                success: function (data) {
                    $('#scanResults').text(JSON.stringify(data.results, null, 2));
                    $('#analysisReportContainer').hide();
                    $('#communityCommentsContainer').hide();
                    $('#zenrowsAnalysisContainer').hide();
                    $('#resultContainer').show();

                    var analysisId = data.results.data.id.split('-')[1];

                    // Fetch analysis report after scanning
                    $.ajax({
                        type: 'GET',
                        url: '/get_analysis_report',
                        data: { analysisId: analysisId },  // Pass the analysisId as a parameter
                        success: function (analysisReport) {
                            // Display only last_analysis_stats
                            var lastAnalysisStats = analysisReport.data.attributes.last_analysis_stats;
                            console.log(lastAnalysisStats);

                            if (lastAnalysisStats.malicious >= 1) {
                                // Perform action for malicious content
                                console.log("Malicious content detected!");
                                $('#analysisReport').text(JSON.stringify({ last_analysis_stats: lastAnalysisStats }, null, 2));
                                $('#analysisReport').append('<br/>Malicious content detected!');
                                $('#analysisReportContainer').show();
                                //searchPulses(url);
                                fetchCommunityComments(analysisId, url);
                                // Perform additional actions as needed
                            } else {
                                // Content is clean
                                console.log("Content is clean.");
                                $('#analysisReport').text(JSON.stringify({ last_analysis_stats: lastAnalysisStats }, null, 2));
                                $('#analysisReport').append('<br/><br/>Content is clean.');
                                $('#analysisReportContainer').show();
                            }
                        },
                        error: function (error) {
                            console.error('Error fetching analysis report:', error);
                            alert('Failed to fetch analysis report. Please try again.');
                        }
                    });
                },
                error: function (error) {
                    console.error('Error scanning URL:', error);
                    alert('Failed to scan URL. Please try again.');
                }
            });
        }

        function extractDomainFromURL(url) {
            // Regular expression to match domain only at the end of the URL
            var domainRegex = /^(https?:\/\/)?([\w\d-]+(\.[\w\d-]+)+)\/?$/;

            // Regular expression to match IP address as the domain
            var ipRegex = /^(https?:\/\/)?(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?:\/.*)?$/;

            var matchDomain = url.match(domainRegex);
            var matchIP = url.match(ipRegex);

            if (matchDomain) {
                // If there's a match for domain, return the domain portion
                return matchDomain[2];
            } else if (matchIP) {
                // If there's a match for IP, return the IP address
                return matchIP[2];
            } else {
                // If no match, return the URL unchanged
                return url;
            }
        }

        function fetchCommunityComments(analysisId, url) {
            $.ajax({
                type: 'GET',
                url: '/get_community_comments',
                data: { analysisId: analysisId },  // Pass the analysisId as a parameter
                success: function (communityComments) {
                    // Check if count is 0
                    if (communityComments.meta.count === 0) {
                        // Send AJAX request to trigger search_pulses function in Python
                        searchPulses(url);
                    } else {
                        // Extract and display only the URL from community comments
                        console.log("Comments", communityComments);
                        var foundComment = false;
                        for (var i = 0; i < communityComments.meta.count; i++) {
                            var commentText = communityComments.data[i].attributes.text;
                            //var match = commentText.match(/Reference: (https:\/\/[^\s]+)/);
                            var match = commentText.match(/Reference: (https?:\/\/[^\s]+)/);
                            if (match) {
                                var virusTotalURL = match[1];
                                foundComment = true;
                                if (!virusTotalURL.endsWith(".txt")) {
                                    // Proceed with further processing
                                    processReference(virusTotalURL);
                                } else {
                                    searchPulses(url);
                                }
                                /*
                                console.log("Matched Comment", match);
                                title = match[1];
                                var searchLink = "https://www.google.com/search?q=" + encodeURIComponent(title);
                                console.log("Google Search Link:", searchLink);
                                searchReferenceViaGoogle(searchLink);
                                */
                                break;  // Stop iterating after finding the first matching comment
                            }
                        }
                        if (foundComment === false) {
                            searchPulses(url);
                        }
                        //processReference(urlReference)
                    }
                },
                error: function (error) {
                    console.error('Error fetching community comments:', error);
                    alert('Failed to fetch community comments. Please try again.');
                }
            });
        }

        function searchReferenceViaGoogle(url) {
            $.ajax({
                type: 'GET',
                url: '/get_zenrows_google?url=' + url,
                success: function (zenrowsAnalysis) {
                    console.log(zenrowsAnalysis.first_link);
                    processReference(zenrowsAnalysis.first_link)
                },
                error: function (error) {
                    console.error('Error fetching Zenrows analysis:', error);
                    alert('Failed to fetch Zenrows analysis. Please try again.');
                }
            });
        }

        function searchPulses(url) {
            url = extractDomainFromURL(url);
            $.ajax({
                type: 'POST',
                url: '/search_pulses',
                contentType: 'application/json',
                data: JSON.stringify({ url: url }),
                success: function (response) {
                    console.log(response);  // Handle the response as needed

                    data = response.pulses.general.pulse_info;
                    var urlReference = null;

                    for (const pulse of data.pulses) {
                        if (pulse.author.username === "AlienVault") {
                            // Grab the reference URL from the pulse with "AlienVault"
                            var username = pulse.author.username;
                            urlReference = pulse.references[0];
                            console.log("Username:", username);
                            processReference(urlReference);
                            return; // Exit function once found
                        }
                    }

                    // If "AlienVault" username not found, check for "CyberHunter_NL"
                    if (!urlReference) {
                        for (const pulse of data.pulses) {
                            if (pulse.author.username === "CyberHunter_NL") {
                                // Grab the reference URL from the pulse with "CyberHunter_NL"
                                var username = pulse.author.username;
                                urlReference = pulse.references[0];
                                console.log("Username:", username);
                                processReference(urlReference);
                                return; // Exit function once found
                            }
                        }
                    }

                    // If "CyberHunter_NL" username not found, check for "CyberHunterAutoFeed"
                    if (!urlReference) {
                        for (const pulse of data.pulses) {
                            if (pulse.author.username === "CyberHunterAutoFeed") {
                                // Grab the reference URL from the pulse with "CyberHunterAutoFeed"
                                var username = pulse.author.username;
                                urlReference = pulse.references[0];
                                var urlDomain = new URL(urlReference).hostname;
                                if (urlDomain === "community.riskiq.com") {
                                    getReferenceURL(urlReference, function(referenceURL) {
                                        if (referenceURL) {
                                            console.log("Username:", username);
                                            processReference(referenceURL)
                                        } else {
                                            console.log('No reference URL found.');
                                        }
                                    });
                                }
                                return; // Exit function once found
                            }
                        }
                    }
                },
                error: function (error) {
                    console.error('Error searching pulses:', error);
                    alert('Failed to search pulses. Please try again.');
                }
            });
        }

        function getReferenceURL(url, callback) {
            $.ajax({
                type: 'GET',
                url: '/get_reference_url?url=' + encodeURIComponent(url),
                success: function(response) {
                    if (response.reference_url) {
                        callback(response.reference_url); // Call the callback function with the reference URL
                    } else {
                        console.log('Error: ', response.error);
                        callback(null); // Call the callback function with null if there's an error
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('Failed to fetch reference URL. Please try again.');
                }
            });
        }

        function processReference(urlReference) {
            console.log("Reference URL:", urlReference);

            var urlPattern = /^(ftp|http|https):\/\/[^ "]+$/;

            if (urlReference && urlPattern.test(urlReference)) {
                var referenceURL = urlReference;
                var referenceMessage = isCompatibleWithZenrows(referenceURL) ? referenceURL : 'URL not compatible with Zenrows.';
                $('#communityComments').text(referenceMessage);
                $('#communityCommentsContainer').show();

                // Check if compatible with Zenrows and fetch Zenrows analysis
                if (isCompatibleWithZenrows(referenceURL)) {
                    fetchZenrowsAnalysis(referenceURL);
                }
            }
        }

        function isCompatibleWithZenrows(url) {
            // Check if the top-level domain is .gov
            var topLevelDomain = new URL(url).hostname.split('.').pop();
            return topLevelDomain.toLowerCase() !== 'gov';
        }
        
        function fetchZenrowsAnalysis(url) {
            // Call the /get_zenrows_analysis endpoint with the reference URL as a parameter
            $.ajax({
                type: 'GET',
                url: '/get_zenrows_analysis?url=' + encodeURIComponent(url),
                success: function (zenrowsAnalysis) {
                    $('#zenrowsAnalysis').text(JSON.stringify(zenrowsAnalysis, null, 2));
                    $('#zenrowsAnalysisContainer').show();
                },
                error: function (error) {
                    console.error('Error fetching Zenrows analysis:', error);
                    alert('Failed to fetch Zenrows analysis. Please try again.');
                }
            });
        }
    </script>
</body>

</html>